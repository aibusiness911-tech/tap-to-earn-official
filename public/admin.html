<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TapToEarn - Admin Panel</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .admin-container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        
        .admin-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00d4ff, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .admin-subtitle {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #00d4ff;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.5);
        }
        
        .stat-label {
            opacity: 0.8;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .admin-sections {
            display: grid;
            gap: 30px;
        }
        
        .section {
            background: rgba(255, 255, 255, 0.15);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        
        .section-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 25px;
            color: #00d4ff;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
        }
        
        .user-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .user-table th,
        .user-table td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .user-table th {
            background: rgba(255, 255, 255, 0.2);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 1px;
        }
        
        .user-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 3px;
            transition: all 0.3s ease;
            font-size: 12px;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #ff6b6b, #ee5a6f);
            color: white;
            box-shadow: 0 4px 15px rgba(238, 90, 111, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(45deg, #51cf66, #40c057);
            color: white;
            box-shadow: 0 4px 15px rgba(64, 192, 87, 0.4);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #74b9ff, #0984e3);
            color: white;
            box-shadow: 0 4px 15px rgba(9, 132, 227, 0.4);
        }

        .btn-warning {
            background: linear-gradient(45deg, #fdcb6e, #e17055);
            color: white;
            box-shadow: 0 4px 15px rgba(253, 203, 110, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .form-input, .form-select {
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            flex: 1;
            min-width: 180px;
            backdrop-filter: blur(10px);
        }

        .form-select option {
            background: #764ba2;
            color: white;
        }
        
        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }
        
        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }
        
        .withdrawal-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #fdcb6e;
            backdrop-filter: blur(10px);
        }
        
        .package-config {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
        }
        
        .package-card {
            background: rgba(255, 255, 255, 0.08);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .access-denied, .loading {
            text-align: center;
            padding: 60px 20px;
        }
        
        .access-denied h1 {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #00d4ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .package-assignment-section {
            background: rgba(253, 203, 110, 0.15);
            border: 2px solid rgba(253, 203, 110, 0.3);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .error-message {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid #ff6b6b;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .success-message {
            background: rgba(81, 207, 102, 0.2);
            border: 1px solid #51cf66;
            color: #51cf66;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .info-message {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
            color: #00d4ff;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .form-input, .form-select {
                min-width: 100%;
            }
        }

        /* Status badges */
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-active {
            background: rgba(81, 207, 102, 0.3);
            color: #51cf66;
        }

        .status-banned {
            background: rgba(255, 107, 107, 0.3);
            color: #ff6b6b;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            text-align: center;
            color: white;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loading State -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <h2>üöÄ Loading TapToEarn Admin Panel...</h2>
            <p>Connecting to Supabase database...</p>
        </div>

        <!-- Access Denied -->
        <div id="accessDenied" class="access-denied" style="display: none;">
            <h1>üö´</h1>
            <h2>Access Denied</h2>
            <p>You don't have admin privileges to access this panel.</p>
            <p>Contact the administrator if you believe this is an error.</p>
        </div>

        <!-- Database Error -->
        <div id="databaseError" class="access-denied" style="display: none;">
            <h1>‚ö†Ô∏è</h1>
            <h2>Database Connection Error</h2>
            <p>Unable to connect to Supabase database.</p>
            <div class="error-message" id="errorDetails"></div>
            <button class="btn btn-primary" onclick="location.reload()">üîÑ Retry Connection</button>
        </div>

        <!-- Admin Panel -->
        <div id="adminPanel" class="admin-container" style="display: none;">
            <div class="header">
                <div class="admin-title">üéØ TapToEarn Admin Control Panel</div>
                <div class="admin-subtitle" id="connectionStatus">Connected to Supabase Database</div>
            </div>

            <!-- Stats Overview -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalRevenue">-</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalTaps">-</div>
                    <div class="stat-label">Total Taps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activePackages">-</div>
                    <div class="stat-label">Active Packages</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingWithdrawals">-</div>
                    <div class="stat-label">Pending Withdrawals</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="totalReferrals">-</div>
                    <div class="stat-label">Total Referrals</div>
                </div>
            </div>

            <div class="admin-sections">
                <!-- User Management -->
                <div class="section">
                    <div class="section-title">üë• User Management</div>
                    
                    <!-- Package Assignment Section -->
                    <div class="package-assignment-section">
                        <h4 style="color: #fdcb6e; margin-bottom: 15px; font-size: 18px;">üì¶ Manual Package Assignment</h4>
                        <p style="font-size: 13px; opacity: 0.8; margin-bottom: 15px;">
                            ‚ö†Ô∏è Use this feature to manually assign packages to users if the auto-checking system fails.
                        </p>
                        <div class="input-group">
                            <input type="number" class="form-input" id="packageUserIdInput" placeholder="Enter Telegram User ID (e.g. 7536805953)">
                            <select class="form-select" id="packageSelect">
                                <option value="">Loading packages...</option>
                            </select>
                            <button class="btn btn-warning" onclick="assignPackageToUser()">üéÅ Assign Package</button>
                        </div>
                    </div>
                    
                    <div class="input-group">
                        <input type="text" class="form-input" id="searchUser" placeholder="Search by username or Telegram ID">
                        <button class="btn btn-primary" onclick="searchUsers()">üîç Search</button>
                        <button class="btn btn-success" onclick="loadAllUsers()">üìã Show All Users</button>
                    </div>

                    <div class="input-group">
                        <input type="number" class="form-input" id="userIdInput" placeholder="Telegram User ID">
                        <input type="number" class="form-input" id="coinsToAdd" placeholder="Coins to add" step="0.01">
                        <button class="btn btn-success" onclick="addCoins()">üí∞ Add Coins</button>
                        <button class="btn btn-danger" onclick="toggleUserBan()">üö´ Ban/Unban User</button>
                    </div>

                    <div style="overflow-x: auto;">
                        <table class="user-table" id="usersTable">
                            <thead>
                                <tr>
                                    <th>Telegram ID</th>
                                    <th>Username</th>
                                    <th>Balance</th>
                                    <th>Total Taps</th>
                                    <th>Level</th>
                                    <th>Referrals</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 30px; opacity: 0.7;">
                                        Click "Show All Users" to load user data
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Withdrawal Management -->
                <div class="section">
                    <div class="section-title">üí≥ Withdrawal Management</div>
                    
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="loadPendingWithdrawals()">üîÑ Load Withdrawals</button>
                        <button class="btn btn-success" onclick="approveAllWithdrawals()">‚úÖ Approve All</button>
                        <button class="btn btn-warning" onclick="loadAllWithdrawals()">üìã Show All Withdrawals</button>
                    </div>
                    
                    <div id="withdrawalsList">
                        <p style="text-align: center; opacity: 0.7; padding: 30px;">
                            Click "Load Withdrawals" to view pending withdrawal requests
                        </p>
                    </div>
                </div>

                <!-- Package Configuration -->
                <div class="section">
                    <div class="section-title">üì¶ Package Configuration</div>
                    
                    <div class="input-group">
                        <input type="text" class="form-input" id="newPackageName" placeholder="Package Name (e.g. Starter Pack)">
                        <input type="number" class="form-input" id="newPackagePrice" placeholder="Price ($)" step="0.01">
                        <input type="number" class="form-input" id="newPackageProfit" placeholder="Max Profit ($)" step="0.01">
                        <input type="number" class="form-input" id="newPackageTapLimit" placeholder="Daily Tap Limit">
                        <input type="number" class="form-input" id="newPackageDuration" placeholder="Duration (days)" value="30">
                        <button class="btn btn-success" onclick="addNewPackage()">‚ûï Add Package</button>
                    </div>
                    
                    <div class="package-config" id="packageConfig">
                        <p style="text-align: center; opacity: 0.7; padding: 30px;">Loading packages...</p>
                    </div>
                </div>

                <!-- Database Status -->
                <div class="section">
                    <div class="section-title">üìä Database Status & Tools</div>
                    <div id="databaseStatus">
                        <p>üîÑ Checking connection...</p>
                    </div>
                    <div class="input-group">
                        <button class="btn btn-primary" onclick="testConnection()">üß™ Test Connection</button>
                        <button class="btn btn-success" onclick="refreshAllData()">üîÑ Refresh All Data</button>
                        <button class="btn btn-warning" onclick="checkDatabaseTables()">üóÉÔ∏è Check Tables</button>
                        <button class="btn btn-danger" onclick="clearCache()">üßπ Clear Cache</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="loading-content">
            <div class="spinner"></div>
            <h3 id="loadingText">Processing...</h3>
        </div>
    </div>

    <script>
        // üîß CONFIGURATION - Update these with your actual values
        const SUPABASE_URL = 'https://arjkzpbhinpqensoqqod.supabase.co';
        const SUPABASE_SERVICE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyamt6cGJoaW5wcWVuc29xcW9kIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NTA2MDAxNSwiZXhwIjoyMDcwNjM2MDE1fQ.dwT80IaEOwk8Gz6qwHD1eZeu6trTCW8krqD0YaAssQU';
        const ADMIN_TELEGRAM_ID = 6733587823;
        
        // Global variables
        let supabase;
        let isSupabaseConnected = false;
        let currentUser = null;
        
        // Initialize Telegram Web App
        const tg = window.Telegram?.WebApp;
        
        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing TapToEarn Admin Panel...');
            initializeSupabase();
            
            // Set up Telegram Web App
            if (tg) {
                tg.ready();
                tg.expand();
                currentUser = tg.initDataUnsafe?.user;
                console.log('üì± Telegram WebApp initialized:', currentUser);
            } else {
                console.log('‚ö†Ô∏è Running without Telegram WebApp (testing mode)');
            }
            
            // Start admin access check
            setTimeout(checkAdminAccess, 1500);
        });

        function initializeSupabase() {
            try {
                console.log('üîå Connecting to Supabase...');
                
                if (!SUPABASE_URL || !SUPABASE_SERVICE_KEY || 
                    SUPABASE_URL.includes('YOUR_') || SUPABASE_SERVICE_KEY.includes('YOUR_')) {
                    throw new Error('Supabase credentials not properly configured');
                }
                
                // Initialize Supabase client with proper configuration
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_SERVICE_KEY, {
                    auth: {
                        autoRefreshToken: false,
                        persistSession: false
                    },
                    global: {
                        headers: {
                            'X-Client-Info': 'taptoearn-admin-panel/1.0'
                        }
                    }
                });
                
                isSupabaseConnected = true;
                console.log('‚úÖ Supabase connected successfully');
                document.getElementById('connectionStatus').textContent = '‚úÖ Connected to Supabase Database';
                
            } catch (error) {
                console.error('‚ùå Supabase connection failed:', error);
                isSupabaseConnected = false;
                showDatabaseError(error.message);
            }
        }

        function showDatabaseError(error) {
            hideElement('loading');
            showElement('databaseError');
            document.getElementById('errorDetails').innerHTML = `
                <strong>Error Details:</strong><br>
                ${error}<br><br>
                <strong>Common Solutions:</strong><br>
                ‚Ä¢ Check if Supabase URL and Service Key are correct<br>
                ‚Ä¢ Ensure database tables exist<br>
                ‚Ä¢ Verify network connection<br>
                ‚Ä¢ Check Supabase project status
            `;
        }

        async function checkAdminAccess() {
            console.log('üîê Checking admin access...');
            
            if (!isSupabaseConnected) {
                console.log('‚ùå Cannot check admin access - database not connected');
                return;
            }

            try {
                // For production: Check if current user is admin
                let isAdmin = false;
                
                if (currentUser && currentUser.id === ADMIN_TELEGRAM_ID) {
                    isAdmin = true;
                    console.log('‚úÖ Admin access granted for Telegram user:', currentUser.id);
                } else {
                    // üîß DEVELOPMENT MODE: Uncomment the line below for testing
                    isAdmin = true; // Remove this line in production!
                    console.log('‚ö†Ô∏è Development mode: Admin access granted for testing');
                }

                setTimeout(() => {
                    hideElement('loading');
                    
                    if (isAdmin) {
                        showElement('adminPanel');
                        loadAdminData();
                    } else {
                        showElement('accessDenied');
                        console.log('‚ùå Access denied - user is not admin');
                    }
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error checking admin access:', error);
                hideElement('loading');
                showElement('accessDenied');
            }
        }

        async function loadAdminData() {
            console.log('üìä Loading admin data...');
            showLoadingOverlay('Loading admin data...');
            
            try {
                // Load all data in parallel with proper error handling
                const results = await Promise.allSettled([
                    testConnection(),
                    loadStats(),
                    loadPackageConfig(),
                    loadPackageSelect(),
                    checkDatabaseTables()
                ]);
                
                // Log results
                results.forEach((result, index) => {
                    const actions = ['testConnection', 'loadStats', 'loadPackageConfig', 'loadPackageSelect', 'checkDatabaseTables'];
                    if (result.status === 'fulfilled') {
                        console.log(`‚úÖ ${actions[index]} completed successfully`);
                    } else {
                        console.warn(`‚ö†Ô∏è ${actions[index]} failed:`, result.reason);
                    }
                });
                
                hideLoadingOverlay();
                showMessage('‚úÖ Admin panel loaded successfully!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error loading admin data:', error);
                hideLoadingOverlay();
                showMessage('‚ö†Ô∏è Some features may not work properly. Check console for details.', 'error');
            }
        }

        async function loadStats() {
            try {
                console.log('üìà Loading statistics...');
                
                // Initialize all stats to 0
                const stats = {
                    totalUsers: 0,
                    totalRevenue: 0,
                    totalTaps: 0,
                    activePackages: 0,
                    pendingWithdrawals: 0,
                    totalReferrals: 0
                };

                // Try to load users
                try {
                    const { data: users, error: usersError } = await supabase
                        .from('users')
                        .select('*');
                    
                    if (usersError) throw usersError;
                    
                    if (users && users.length > 0) {
                        stats.totalUsers = users.length;
                        stats.totalTaps = users.reduce((sum, user) => sum + (user.total_taps || 0), 0);
                        stats.totalReferrals = users.reduce((sum, user) => sum + (user.referral_count || 0), 0);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not load users table:', error.message);
                }

                // Try to load packages
                try {
                    const { data: userPackages, error: packagesError } = await supabase
                        .from('user_packages')
                        .select(`
                            *,
                            packages (price)
                        `);
                    
                    if (packagesError) throw packagesError;
                    
                    if (userPackages && userPackages.length > 0) {
                        stats.totalRevenue = userPackages.reduce((sum, pkg) => sum + (pkg.packages?.price || 0), 0);
                        stats.activePackages = userPackages.filter(pkg => pkg.is_active).length;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not load user_packages table:', error.message);
                }

                // Try to load withdrawals
                try {
                    const { data: withdrawals, error: withdrawalsError } = await supabase
                        .from('withdrawals')
                        .select('*');
                    
                    if (withdrawalsError) throw withdrawalsError;
                    
                    if (withdrawals && withdrawals.length > 0) {
                        stats.pendingWithdrawals = withdrawals.filter(w => w.status === 'pending').length;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Could not load withdrawals table:', error.message);
                }

                // Update stats display
                updateStatsDisplay(stats);
                console.log('üìä Stats loaded:', stats);
                
            } catch (error) {
                console.error('‚ùå Error loading stats:', error);
                // Set default values on error
                updateStatsDisplay({
                    totalUsers: '?',
                    totalRevenue: '?',
                    totalTaps: '?',
                    activePackages: '?',
                    pendingWithdrawals: '?',
                    totalReferrals: '?'
                });
            }
        }

        function updateStatsDisplay(stats) {
            document.getElementById('totalUsers').textContent = stats.totalUsers;
            document.getElementById('totalRevenue').textContent = typeof stats.totalRevenue === 'number' ? 
                ' + stats.totalRevenue.toFixed(2) : stats.totalRevenue;
            document.getElementById('totalTaps').textContent = typeof stats.totalTaps === 'number' ? 
                stats.totalTaps.toLocaleString() : stats.totalTaps;
            document.getElementById('activePackages').textContent = stats.activePackages;
            document.getElementById('pendingWithdrawals').textContent = stats.pendingWithdrawals;
            document.getElementById('totalReferrals').textContent = stats.totalReferrals;
        }

        async function loadPackageSelect() {
            try {
                console.log('üì¶ Loading package options...');
                
                const { data: packages, error } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('is_active', true)
                    .order('price', { ascending: true });
                
                const select = document.getElementById('packageSelect');
                select.innerHTML = '<option value="">Select Package</option>';
                
                if (error) {
                    console.warn('‚ö†Ô∏è Could not load packages:', error.message);
                    select.innerHTML = '<option value="">No packages available</option>';
                    return;
                }
                
                if (!packages || packages.length === 0) {
                    select.innerHTML = '<option value="">No active packages found</option>';
                    return;
                }
                
                packages.forEach(pkg => {
                    const option = document.createElement('option');
                    option.value = pkg.id;
                    option.textContent = `${pkg.name} - ${parseFloat(pkg.price).toFixed(2)}`;
                    select.appendChild(option);
                });
                
                console.log(`‚úÖ Loaded ${packages.length} packages for assignment`);
                
            } catch (error) {
                console.error('‚ùå Error loading package select:', error);
                const select = document.getElementById('packageSelect');
                select.innerHTML = '<option value="">Error loading packages</option>';
            }
        }

        async function assignPackageToUser() {
            const userId = document.getElementById('packageUserIdInput').value.trim();
            const packageId = document.getElementById('packageSelect').value;
            
            // Validation
            if (!userId) {
                showMessage('‚ùå Please enter a Telegram User ID!', 'error');
                document.getElementById('packageUserIdInput').focus();
                return;
            }
            
            if (!packageId) {
                showMessage('‚ùå Please select a package to assign!', 'error');
                document.getElementById('packageSelect').focus();
                return;
            }

            // Validate user ID format
            if (!/^\d+$/.test(userId)) {
                showMessage('‚ùå User ID must be a number!', 'error');
                return;
            }

            try {
                showLoadingOverlay('Assigning package...');

                // Check if user exists
                const { data: user, error: getUserError } = await supabase
                    .from('users')
                    .select('telegram_id, username, first_name, last_name')
                    .eq('telegram_id', userId)
                    .single();

                if (getUserError || !user) {
                    throw new Error(`User with ID ${userId} not found. User must start the bot first.`);
                }

                // Get package details
                const { data: packageData, error: getPackageError } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('id', packageId)
                    .single();

                if (getPackageError || !packageData) {
                    throw new Error('Selected package not found');
                }

                // Check if user already has this package active
                const { data: existingPackage, error: checkError } = await supabase
                    .from('user_packages')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('package_id', packageId)
                    .eq('is_active', true);

                if (checkError) throw checkError;

                if (existingPackage && existingPackage.length > 0) {
                    throw new Error('User already has this package active!');
                }

                // Calculate dates
                const purchaseDate = new Date();
                const expiryDate = new Date(purchaseDate);
                expiryDate.setDate(expiryDate.getDate() + (packageData.duration_days || 30));

                // Assign package to user
                const { error: assignError } = await supabase
                    .from('user_packages')
                    .insert({
                        user_id: userId,
                        package_id: packageId,
                        purchase_date: purchaseDate.toISOString(),
                        expiry_date: expiryDate.toISOString(),
                        is_active: true,
                        remaining_profit: packageData.max_profit,
                        daily_taps_used: 0,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                if (assignError) throw assignError;

                // Log admin action (optional - only if admin_logs table exists)
                try {
                    await supabase
                        .from('admin_logs')
                        .insert({
                            admin_telegram_id: ADMIN_TELEGRAM_ID,
                            action: 'assign_package',
                            target_user_id: userId,
                            details: {
                                package_id: packageId,
                                package_name: packageData.name,
                                package_price: packageData.price,
                                assigned_manually: true
                            },
                            created_at: new Date().toISOString()
                        });
                } catch (logError) {
                    console.warn('‚ö†Ô∏è Could not log admin action:', logError.message);
                }

                hideLoadingOverlay();
                
                const userName = user.username || user.first_name || `ID: ${userId}`;
                showMessage(`‚úÖ Package "${packageData.name}" successfully assigned to ${userName}!`, 'success');
                
                // Clear inputs
                document.getElementById('packageUserIdInput').value = '';
                document.getElementById('packageSelect').value = '';
                
                // Refresh stats
                await loadStats();
                
            } catch (error) {
                console.error('‚ùå Error assigning package:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to assign package: ${error.message}`, 'error');
            }
        }

        async function loadAllUsers() {
            try {
                showLoadingOverlay('Loading all users...');
                
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(100); // Limit to prevent performance issues
                
                if (error) throw error;

                displayUsers(users || []);
                hideLoadingOverlay();
                showMessage(`‚úÖ Loaded ${users?.length || 0} users`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error loading users:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to load users: ${error.message}`, 'error');
                
                // Show empty state
                const tbody = document.getElementById('usersTableBody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 30px; color: #ff6b6b;">
                            ‚ùå Error loading users: ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (!users || users.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 30px; opacity: 0.7;">
                            üì≠ No users found
                        </td>
                    </tr>
                `;
                return;
            }

            users.forEach(user => {
                const row = document.createElement('tr');
                const joinDate = user.created_at ? new Date(user.created_at).toLocaleDateString() : 'Unknown';
                const status = user.is_banned ? 'banned' : 'active';
                const statusClass = user.is_banned ? 'status-banned' : 'status-active';
                
                row.innerHTML = `
                    <td><code>${user.telegram_id}</code></td>
                    <td>${user.username ? '@' + user.username : user.first_name || 'N/A'}</td>
                    <td>üí∞ ${parseFloat(user.balance || 0).toFixed(2)}</td>
                    <td>üëÜ ${(user.total_taps || 0).toLocaleString()}</td>
                    <td>üèÜ ${user.level || 1}</td>
                    <td>üë• ${user.referral_count || 0}</td>
                    <td><span class="status-badge ${statusClass}">${status}</span></td>
                    <td>${joinDate}</td>
                    <td>
                        <button class="btn btn-primary" onclick="viewUserDetails('${user.telegram_id}')" title="View Details">üëÅÔ∏è</button>
                        <button class="btn ${user.is_banned ? 'btn-success' : 'btn-danger'}" onclick="toggleUserBan('${user.telegram_id}')" title="${user.is_banned ? 'Unban' : 'Ban'} User">
                            ${user.is_banned ? '‚úÖ' : 'üö´'}
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function searchUsers() {
            const searchTerm = document.getElementById('searchUser').value.trim();
            
            if (!searchTerm) {
                showMessage('‚ùå Please enter a search term!', 'error');
                return;
            }

            try {
                showLoadingOverlay('Searching users...');
                
                let query = supabase.from('users').select('*');
                
                // Check if search term is numeric (Telegram ID)
                if (/^\d+$/.test(searchTerm)) {
                    query = query.eq('telegram_id', searchTerm);
                } else {
                    // Search by username or name
                    query = query.or(`username.ilike.%${searchTerm}%,first_name.ilike.%${searchTerm}%,last_name.ilike.%${searchTerm}%`);
                }
                
                const { data: users, error } = await query.order('created_at', { ascending: false });
                
                if (error) throw error;

                displayUsers(users || []);
                hideLoadingOverlay();
                showMessage(`‚úÖ Found ${users?.length || 0} users matching "${searchTerm}"`, 'success');
                
            } catch (error) {
                console.error('‚ùå Search failed:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Search failed: ${error.message}`, 'error');
            }
        }

        async function addCoins() {
            const userId = document.getElementById('userIdInput').value.trim();
            const coinsToAdd = parseFloat(document.getElementById('coinsToAdd').value);
            
            // Validation
            if (!userId) {
                showMessage('‚ùå Please enter a User ID!', 'error');
                return;
            }
            
            if (!coinsToAdd || coinsToAdd <= 0) {
                showMessage('‚ùå Please enter a positive amount of coins!', 'error');
                return;
            }

            try {
                showLoadingOverlay('Adding coins...');

                // Get current user data
                const { data: user, error: getUserError } = await supabase
                    .from('users')
                    .select('balance, username, first_name')
                    .eq('telegram_id', userId)
                    .single();

                if (getUserError || !user) {
                    throw new Error('User not found');
                }

                // Calculate new balance
                const currentBalance = parseFloat(user.balance || 0);
                const newBalance = currentBalance + coinsToAdd;
                
                // Update user balance
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ 
                        balance: newBalance,
                        updated_at: new Date().toISOString()
                    })
                    .eq('telegram_id', userId);

                if (updateError) throw updateError;

                // Log transaction (optional)
                try {
                    await supabase
                        .from('transactions')
                        .insert({
                            user_id: userId,
                            type: 'admin_add',
                            amount: coinsToAdd,
                            description: `Admin added ${coinsToAdd} coins`,
                            created_at: new Date().toISOString()
                        });
                } catch (transactionError) {
                    console.warn('‚ö†Ô∏è Could not log transaction:', transactionError.message);
                }

                hideLoadingOverlay();
                
                const userName = user.username || user.first_name || userId;
                showMessage(`‚úÖ Added ${coinsToAdd} coins to ${userName}'s account! New balance: ${newBalance.toFixed(2)}`, 'success');
                
                // Clear inputs
                document.getElementById('userIdInput').value = '';
                document.getElementById('coinsToAdd').value = '';
                
                // Refresh user list if visible
                const tableBody = document.getElementById('usersTableBody');
                if (tableBody.children.length > 1 || !tableBody.textContent.includes('Click "Show All Users"')) {
                    await loadAllUsers();
                }
                
            } catch (error) {
                console.error('‚ùå Error adding coins:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to add coins: ${error.message}`, 'error');
            }
        }

        async function toggleUserBan(userTelegramId = null) {
            const userId = userTelegramId || document.getElementById('userIdInput').value.trim();
            
            if (!userId) {
                showMessage('‚ùå Please enter a User ID!', 'error');
                return;
            }

            try {
                showLoadingOverlay('Updating user status...');

                // Get current user status
                const { data: user, error: getUserError } = await supabase
                    .from('users')
                    .select('is_banned, username, first_name')
                    .eq('telegram_id', userId)
                    .single();

                if (getUserError || !user) {
                    throw new Error('User not found');
                }

                const newStatus = !user.is_banned;
                const action = newStatus ? 'banned' : 'unbanned';
                
                // Update user status
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ 
                        is_banned: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('telegram_id', userId);

                if (updateError) throw updateError;

                hideLoadingOverlay();
                
                const userName = user.username || user.first_name || userId;
                showMessage(`‚úÖ User ${userName} has been ${action}!`, 'success');
                
                // Clear input if not called from table
                if (!userTelegramId) {
                    document.getElementById('userIdInput').value = '';
                }
                
                // Refresh user list if visible
                const tableBody = document.getElementById('usersTableBody');
                if (tableBody.children.length > 1 || !tableBody.textContent.includes('Click "Show All Users"')) {
                    await loadAllUsers();
                }
                
            } catch (error) {
                console.error('‚ùå Error toggling user ban:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to update user status: ${error.message}`, 'error');
            }
        }

        async function loadPendingWithdrawals() {
            try {
                showLoadingOverlay('Loading withdrawals...');
                
                const { data: withdrawals, error } = await supabase
                    .from('withdrawals')
                    .select(`
                        *,
                        users!withdrawals_user_id_fkey (username, first_name)
                    `)
                    .eq('status', 'pending')
                    .order('request_date', { ascending: false });
                
                if (error) throw error;

                displayWithdrawals(withdrawals || [], 'pending');
                hideLoadingOverlay();
                showMessage(`‚úÖ Loaded ${withdrawals?.length || 0} pending withdrawals`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error loading withdrawals:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to load withdrawals: ${error.message}`, 'error');
                
                const container = document.getElementById('withdrawalsList');
                container.innerHTML = `
                    <div class="error-message">
                        ‚ùå Error loading withdrawals: ${error.message}
                    </div>
                `;
            }
        }

        async function loadAllWithdrawals() {
            try {
                showLoadingOverlay('Loading all withdrawals...');
                
                const { data: withdrawals, error } = await supabase
                    .from('withdrawals')
                    .select(`
                        *,
                        users!withdrawals_user_id_fkey (username, first_name)
                    `)
                    .order('request_date', { ascending: false })
                    .limit(50);
                
                if (error) throw error;

                displayWithdrawals(withdrawals || [], 'all');
                hideLoadingOverlay();
                showMessage(`‚úÖ Loaded ${withdrawals?.length || 0} withdrawals`, 'success');
                
            } catch (error) {
                console.error('‚ùå Error loading all withdrawals:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to load withdrawals: ${error.message}`, 'error');
            }
        }

        function displayWithdrawals(withdrawals, type = 'pending') {
            const container = document.getElementById('withdrawalsList');
            container.innerHTML = '';

            if (!withdrawals || withdrawals.length === 0) {
                const message = type === 'pending' ? 'No pending withdrawals' : 'No withdrawals found';
                container.innerHTML = `
                    <p style="text-align: center; opacity: 0.7; padding: 30px;">
                        üì≠ ${message}
                    </p>
                `;
                return;
            }

            withdrawals.forEach(withdrawal => {
                const card = document.createElement('div');
                card.className = 'withdrawal-card';
                
                const userName = withdrawal.users?.username || withdrawal.users?.first_name || 'Unknown User';
                const requestDate = new Date(withdrawal.request_date).toLocaleString();
                const statusColor = {
                    pending: '#fdcb6e',
                    approved: '#51cf66',
                    rejected: '#ff6b6b'
                }[withdrawal.status] || '#74b9ff';

                card.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 15px;">
                        <div style="flex: 1; min-width: 300px;">
                            <h4 style="margin-bottom: 8px; color: #00d4ff;">üë§ ${userName}</h4>
                            <p><strong>User ID:</strong> <code>${withdrawal.user_id}</code></p>
                            <p><strong>Amount:</strong> <span style="color: #51cf66; font-size: 18px; font-weight: bold;">${parseFloat(withdrawal.amount).toFixed(2)} coins</span></p>
                            <p><strong>Wallet:</strong> <code style="word-break: break-all; background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px;">${withdrawal.wallet_address}</code></p>
                            <p><strong>Status:</strong> <span style="color: ${statusColor}; font-weight: bold; text-transform: uppercase;">${withdrawal.status}</span></p>
                            <p><strong>Requested:</strong> ${requestDate}</p>
                            ${withdrawal.processed_date ? `<p><strong>Processed:</strong> ${new Date(withdrawal.processed_date).toLocaleString()}</p>` : ''}
                            ${withdrawal.admin_notes ? `<p><strong>Notes:</strong> ${withdrawal.admin_notes}</p>` : ''}
                        </div>
                        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${withdrawal.status === 'pending' ? `
                                <button class="btn btn-success" onclick="approveWithdrawal(${withdrawal.id})" title="Approve Withdrawal">‚úÖ Approve</button>
                                <button class="btn btn-danger" onclick="rejectWithdrawal(${withdrawal.id})" title="Reject Withdrawal">‚ùå Reject</button>
                            ` : `
                                <span style="padding: 8px 12px; background: rgba(${statusColor.replace('#', '')}, 0.2); color: ${statusColor}; border-radius: 6px; font-size: 12px; font-weight: bold;">
                                    ${withdrawal.status.toUpperCase()}
                                </span>
                            `}
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function approveWithdrawal(withdrawalId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to APPROVE this withdrawal?\n\nThis action cannot be undone.')) {
                return;
            }

            try {
                showLoadingOverlay('Approving withdrawal...');
                
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'approved',
                        processed_date: new Date().toISOString(),
                        processed_by: ADMIN_TELEGRAM_ID
                    })
                    .eq('id', withdrawalId);

                if (error) throw error;

                hideLoadingOverlay();
                showMessage('‚úÖ Withdrawal approved successfully!', 'success');
                await loadPendingWithdrawals();
                await loadStats(); // Refresh stats
                
            } catch (error) {
                console.error('‚ùå Error approving withdrawal:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to approve withdrawal: ${error.message}`, 'error');
            }
        }

        async function rejectWithdrawal(withdrawalId) {
            const reason = prompt('üí¨ Enter reason for rejection (optional):');
            
            if (!confirm('‚ö†Ô∏è Are you sure you want to REJECT this withdrawal?\n\nThis action cannot be undone.')) {
                return;
            }

            try {
                showLoadingOverlay('Rejecting withdrawal...');
                
                const { error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'rejected',
                        processed_date: new Date().toISOString(),
                        processed_by: ADMIN_TELEGRAM_ID,
                        admin_notes: reason || 'Rejected by admin'
                    })
                    .eq('id', withdrawalId);

                if (error) throw error;

                hideLoadingOverlay();
                showMessage('‚ùå Withdrawal rejected successfully!', 'success');
                await loadPendingWithdrawals();
                await loadStats(); // Refresh stats
                
            } catch (error) {
                console.error('‚ùå Error rejecting withdrawal:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to reject withdrawal: ${error.message}`, 'error');
            }
        }

        async function approveAllWithdrawals() {
            if (!confirm('‚ö†Ô∏è Are you sure you want to APPROVE ALL pending withdrawals?\n\nThis action cannot be undone and may involve significant amounts.')) {
                return;
            }

            try {
                showLoadingOverlay('Approving all withdrawals...');
                
                const { data, error } = await supabase
                    .from('withdrawals')
                    .update({ 
                        status: 'approved',
                        processed_date: new Date().toISOString(),
                        processed_by: ADMIN_TELEGRAM_ID
                    })
                    .eq('status', 'pending')
                    .select('id');

                if (error) throw error;

                const approvedCount = data?.length || 0;
                hideLoadingOverlay();
                showMessage(`‚úÖ Successfully approved ${approvedCount} withdrawal(s)!`, 'success');
                await loadPendingWithdrawals();
                await loadStats(); // Refresh stats
                
            } catch (error) {
                console.error('‚ùå Error approving all withdrawals:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to approve withdrawals: ${error.message}`, 'error');
            }
        }

        async function loadPackageConfig() {
            try {
                console.log('üì¶ Loading package configuration...');
                
                const { data: packages, error } = await supabase
                    .from('packages')
                    .select('*')
                    .order('price', { ascending: true });
                
                if (error) throw error;

                displayPackages(packages || []);
                console.log(`‚úÖ Loaded ${packages?.length || 0} packages`);
                
            } catch (error) {
                console.error('‚ùå Error loading packages:', error);
                const container = document.getElementById('packageConfig');
                container.innerHTML = `
                    <div class="error-message">
                        ‚ùå Error loading packages: ${error.message}
                    </div>
                `;
            }
        }

        function displayPackages(packages) {
            const container = document.getElementById('packageConfig');
            container.innerHTML = '';

            if (!packages || packages.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; opacity: 0.7; padding: 30px;">
                        üì≠ No packages found. Create your first package below.
                    </p>
                `;
                return;
            }

            packages.forEach(pkg => {
                const card = document.createElement('div');
                card.className = 'package-card';
                
                const statusColor = pkg.is_active ? '#51cf66' : '#ff6b6b';
                const statusText = pkg.is_active ? 'ACTIVE' : 'INACTIVE';
                
                card.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: flex-start; margin-bottom: 15px;">
                        <h4 style="color: #00d4ff; margin: 0; flex: 1;">${pkg.name}</h4>
                        <span class="status-badge" style="background: rgba(${statusColor.replace('#', '')}, 0.3); color: ${statusColor};">
                            ${statusText}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                        <div>
                            <p><strong>üí∞ Price:</strong> ${parseFloat(pkg.price).toFixed(2)}</p>
                            <p><strong>üéØ Max Profit:</strong> ${parseFloat(pkg.max_profit).toFixed(2)}</p>
                        </div>
                        <div>
                            <p><strong>‚è±Ô∏è Duration:</strong> ${pkg.duration_days || 30} days</p>
                            <p><strong>üëÜ Daily Taps:</strong> ${pkg.daily_tap_limit || 0}</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="editPackage(${pkg.id})" title="Edit Package">‚úèÔ∏è Edit</button>
                        <button class="btn btn-${pkg.is_active ? 'danger' : 'success'}" onclick="togglePackage(${pkg.id})" title="${pkg.is_active ? 'Disable' : 'Enable'} Package">
                            ${pkg.is_active ? 'üö´ Disable' : '‚úÖ Enable'}
                        </button>
                        <button class="btn btn-warning" onclick="viewPackageStats(${pkg.id})" title="View Statistics">üìä Stats</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        async function addNewPackage() {
            const name = document.getElementById('newPackageName').value.trim();
            const price = parseFloat(document.getElementById('newPackagePrice').value);
            const profit = parseFloat(document.getElementById('newPackageProfit').value);
            const tapLimit = parseInt(document.getElementById('newPackageTapLimit').value);
            const duration = parseInt(document.getElementById('newPackageDuration').value) || 30;

            // Validation
            if (!name) {
                showMessage('‚ùå Please enter a package name!', 'error');
                return;
            }
            
            if (!price || price <= 0) {
                showMessage('‚ùå Please enter a valid price!', 'error');
                return;
            }
            
            if (!profit || profit <= 0) {
                showMessage('‚ùå Please enter a valid max profit!', 'error');
                return;
            }
            
            if (!tapLimit || tapLimit <= 0) {
                showMessage('‚ùå Please enter a valid daily tap limit!', 'error');
                return;
            }

            try {
                showLoadingOverlay('Creating package...');

                const { error } = await supabase
                    .from('packages')
                    .insert({
                        name: name,
                        price: price,
                        max_profit: profit,
                        daily_tap_limit: tapLimit,
                        duration_days: duration,
                        is_active: true,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString()
                    });

                if (error) throw error;

                hideLoadingOverlay();
                showMessage(`‚úÖ Package "${name}" created successfully!`, 'success');
                
                // Clear inputs
                document.getElementById('newPackageName').value = '';
                document.getElementById('newPackagePrice').value = '';
                document.getElementById('newPackageProfit').value = '';
                document.getElementById('newPackageTapLimit').value = '';
                document.getElementById('newPackageDuration').value = '30';
                
                // Refresh package list and options
                await Promise.all([
                    loadPackageConfig(),
                    loadPackageSelect()
                ]);
                
            } catch (error) {
                console.error('‚ùå Error creating package:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to create package: ${error.message}`, 'error');
            }
        }

        async function togglePackage(packageId) {
            try {
                showLoadingOverlay('Updating package...');
                
                // Get current package status
                const { data: pkg, error: getError } = await supabase
                    .from('packages')
                    .select('is_active, name')
                    .eq('id', packageId)
                    .single();

                if (getError || !pkg) throw new Error('Package not found');

                const newStatus = !pkg.is_active;
                
                const { error } = await supabase
                    .from('packages')
                    .update({ 
                        is_active: newStatus,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', packageId);

                if (error) throw error;

                hideLoadingOverlay();
                showMessage(`‚úÖ Package "${pkg.name}" ${newStatus ? 'enabled' : 'disabled'}!`, 'success');
                
                await Promise.all([
                    loadPackageConfig(),
                    loadPackageSelect()
                ]);
                
            } catch (error) {
                console.error('‚ùå Error toggling package:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to update package: ${error.message}`, 'error');
            }
        }

        async function editPackage(packageId) {
            try {
                // Get current package data
                const { data: pkg, error: getError } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('id', packageId)
                    .single();

                if (getError || !pkg) throw new Error('Package not found');

                // Get new values from user
                const newName = prompt(`üìù Enter new name for "${pkg.name}":`, pkg.name);
                if (!newName || newName === pkg.name) return;

                const newPrice = prompt(`üí∞ Enter new price for "${pkg.name}":`, pkg.price);
                if (!newPrice || parseFloat(newPrice) <= 0) return;

                const newProfit = prompt(`üéØ Enter new max profit for "${pkg.name}":`, pkg.max_profit);
                if (!newProfit || parseFloat(newProfit) <= 0) return;

                const newTapLimit = prompt(`üëÜ Enter new daily tap limit for "${pkg.name}":`, pkg.daily_tap_limit);
                if (!newTapLimit || parseInt(newTapLimit) <= 0) return;

                showLoadingOverlay('Updating package...');

                const { error } = await supabase
                    .from('packages')
                    .update({ 
                        name: newName.trim(),
                        price: parseFloat(newPrice),
                        max_profit: parseFloat(newProfit),
                        daily_tap_limit: parseInt(newTapLimit),
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', packageId);

                if (error) throw error;

                hideLoadingOverlay();
                showMessage(`‚úÖ Package "${newName}" updated successfully!`, 'success');
                
                await Promise.all([
                    loadPackageConfig(),
                    loadPackageSelect()
                ]);
                
            } catch (error) {
                console.error('‚ùå Error editing package:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to edit package: ${error.message}`, 'error');
            }
        }

        async function viewPackageStats(packageId) {
            try {
                showLoadingOverlay('Loading package statistics...');
                
                // Get package info
                const { data: pkg, error: pkgError } = await supabase
                    .from('packages')
                    .select('*')
                    .eq('id', packageId)
                    .single();

                if (pkgError || !pkg) throw new Error('Package not found');

                // Get user packages for this package
                const { data: userPackages, error: upError } = await supabase
                    .from('user_packages')
                    .select('*')
                    .eq('package_id', packageId);

                if (upError) throw upError;

                hideLoadingOverlay();

                const totalPurchases = userPackages?.length || 0;
                const activePurchases = userPackages?.filter(up => up.is_active).length || 0;
                const totalRevenue = totalPurchases * pkg.price;
                
                const stats = `
üîç Package Statistics: ${pkg.name}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ Price: ${pkg.price}
üéØ Max Profit: ${pkg.max_profit}
‚è±Ô∏è Duration: ${pkg.duration_days} days
üëÜ Daily Tap Limit: ${pkg.daily_tap_limit}
üìä Status: ${pkg.is_active ? 'Active' : 'Inactive'}

üìà Sales Statistics:
‚Ä¢ Total Purchases: ${totalPurchases}
‚Ä¢ Active Purchases: ${activePurchases}
‚Ä¢ Total Revenue: ${totalRevenue.toFixed(2)}
‚Ä¢ Created: ${new Date(pkg.created_at).toLocaleDateString()}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                `.trim();
                
                alert(stats);
                
            } catch (error) {
                console.error('‚ùå Error loading package stats:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to load package stats: ${error.message}`, 'error');
            }
        }

        async function testConnection() {
            try {
                console.log('üîß Testing database connection...');
                
                // Test with a simple query
                const { data, error } = await supabase
                    .from('users')
                    .select('telegram_id')
                    .limit(1);
                
                if (error) {
                    if (error.code === 'PGRST116') {
                        // Table doesn't exist
                        document.getElementById('databaseStatus').innerHTML = `
                            <div class="error-message">
                                ‚ö†Ô∏è Database connected but 'users' table doesn't exist!
                                <br><small>Please set up your database tables first.</small>
                            </div>
                            <p><small>Last checked: ${new Date().toLocaleString()}</small></p>
                        `;
                        return;
                    }
                    throw error;
                }
                
                document.getElementById('databaseStatus').innerHTML = `
                    <div class="success-message">
                        ‚úÖ Database connection successful!
                        <br><small>All systems operational.</small>
                    </div>
                    <p><small>Last checked: ${new Date().toLocaleString()}</small></p>
                `;
                
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
                document.getElementById('databaseStatus').innerHTML = `
                    <div class="error-message">
                        ‚ùå Database connection failed!
                        <br><strong>Error:</strong> ${error.message}
                        <br><small>Code: ${error.code || 'Unknown'}</small>
                    </div>
                    <p><small>Last checked: ${new Date().toLocaleString()}</small></p>
                `;
            }
        }

        async function checkDatabaseTables() {
            try {
                showLoadingOverlay('Checking database tables...');
                
                const tables = ['users', 'packages', 'user_packages', 'withdrawals', 'transactions', 'admin_logs'];
                const results = {};
                
                for (const table of tables) {
                    try {
                        const { data, error } = await supabase
                            .from(table)
                            .select('*')
                            .limit(1);
                        
                        if (error) {
                            results[table] = { exists: false, error: error.message };
                        } else {
                            results[table] = { exists: true, records: data?.length || 0 };
                        }
                    } catch (err) {
                        results[table] = { exists: false, error: err.message };
                    }
                }
                
                hideLoadingOverlay();
                
                let message = 'üìä Database Table Status:\n\n';
                for (const [table, result] of Object.entries(results)) {
                    const status = result.exists ? '‚úÖ' : '‚ùå';
                    const info = result.exists ? `(${result.records} records)` : `- ${result.error}`;
                    message += `${status} ${table} ${info}\n`;
                }
                
                alert(message);
                
            } catch (error) {
                console.error('‚ùå Error checking tables:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to check tables: ${error.message}`, 'error');
            }
        }

        async function refreshAllData() {
            try {
                showLoadingOverlay('Refreshing all data...');
                
                // Reload all data
                await Promise.allSettled([
                    loadStats(),
                    loadPackageConfig(),
                    loadPackageSelect(),
                    testConnection()
                ]);
                
                hideLoadingOverlay();
                showMessage('‚úÖ All data refreshed successfully!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error refreshing data:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to refresh data: ${error.message}`, 'error');
            }
        }

        async function clearCache() {
            if (!confirm('üóëÔ∏è Clear all cached data?\n\nThis will reload all information from the database.')) {
                return;
            }
            
            try {
                showLoadingOverlay('Clearing cache...');
                
                // Clear any cached data (if you implement caching later)
                // For now, just refresh everything
                await refreshAllData();
                
                hideLoadingOverlay();
                showMessage('üßπ Cache cleared and data refreshed!', 'success');
                
            } catch (error) {
                console.error('‚ùå Error clearing cache:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to clear cache: ${error.message}`, 'error');
            }
        }

        async function viewUserDetails(userId) {
            try {
                showLoadingOverlay('Loading user details...');
                
                const { data: user, error } = await supabase
                    .from('users')
                    .select(`
                        *,
                        user_packages!user_packages_user_id_fkey (
                            *,
                            packages (name, price)
                        )
                    `)
                    .eq('telegram_id', userId)
                    .single();
                
                if (error || !user) throw new Error('User not found');

                hideLoadingOverlay();

                const activePackages = user.user_packages?.filter(up => up.is_active) || [];
                const totalInvested = user.user_packages?.reduce((sum, up) => sum + (up.packages?.price || 0), 0) || 0;

                const details = `
üë§ User Profile: ${user.username || user.first_name || 'Unknown'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üì± Telegram ID: ${user.telegram_id}
üë§ Username: @${user.username || 'none'}
üìù Name: ${user.first_name || ''} ${user.last_name || ''}
üí∞ Balance: ${parseFloat(user.balance || 0).toFixed(2)} coins
üëÜ Total Taps: ${(user.total_taps || 0).toLocaleString()}
‚ö° Energy: ${user.energy || 0}/${user.max_energy || 1000}
üèÜ Level: ${user.level || 1}
üíµ Total Invested: ${totalInvested.toFixed(2)}
üì¶ Active Packages: ${activePackages.length}
üë• Referrals: ${user.referral_count || 0}
üí≥ Wallet: ${user.wallet_address || 'Not set'}
üö¶ Status: ${user.is_banned ? 'üö´ BANNED' : '‚úÖ ACTIVE'}
üìÖ Joined: ${new Date(user.created_at).toLocaleDateString()}
üïí Last Active: ${new Date(user.last_active || user.created_at).toLocaleString()}

üì¶ Package Details:
${activePackages.length > 0 ? activePackages.map(pkg => 
    `‚Ä¢ ${pkg.packages?.name || 'Unknown'} - ${pkg.packages?.price || 0} (Active)`
).join('\n') : '‚Ä¢ No active packages'}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                `.trim();
                
                alert(details);
                
            } catch (error) {
                console.error('‚ùå Error loading user details:', error);
                hideLoadingOverlay();
                showMessage(`‚ùå Failed to load user details: ${error.message}`, 'error');
            }
        }

        // Utility Functions
        function showElement(elementId) {
            document.getElementById(elementId).style.display = 'block';
        }

        function hideElement(elementId) {
            document.getElementById(elementId).style.display = 'none';
        }

        function showLoadingOverlay(message = 'Loading...') {
            document.getElementById('loadingText').textContent = message;
            document.getElementById('loadingOverlay').style.display = 'flex';
        }

        function hideLoadingOverlay() {
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showMessage(message, type = 'success') {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.floating-message');
            existingMessages.forEach(msg => msg.remove());

            const messageDiv = document.createElement('div');
            messageDiv.className = 'floating-message';
            
            const colors = {
                success: { bg: 'rgba(81, 207, 102, 0.9)', border: '#51cf66', text: '#fff' },
                error: { bg: 'rgba(255, 107, 107, 0.9)', border: '#ff6b6b', text: '#fff' },
                info: { bg: 'rgba(0, 212, 255, 0.9)', border: '#00d4ff', text: '#fff' }
            };
            
            const color = colors[type] || colors.info;
            
            messageDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${color.bg};
                border: 2px solid ${color.border};
                color: ${color.text};
                padding: 15px 20px;
                border-radius: 10px;
                font-weight: 600;
                z-index: 10000;
                max-width: 400px;
                word-wrap: break-word;
                animation: slideInRight 0.3s ease-out;
                box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(10px);
            `;
            
            messageDiv.textContent = message;
            document.body.appendChild(messageDiv);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                messageDiv.style.animation = 'slideOutRight 0.3s ease-in';
                setTimeout(() => messageDiv.remove(), 300);
            }, 5000);
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
            
            .floating-message {
                animation: slideInRight 0.3s ease-out;
            }
        `;
        document.head.appendChild(style);

        // Error handling for unhandled promise rejections
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            showMessage('An unexpected error occurred. Check console for details.', 'error');
        });

        // Initialize on page load
        console.log('üéØ TapToEarn Admin Panel Script Loaded');
    </script>
</body>
</html>
